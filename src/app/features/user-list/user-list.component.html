<!-- Add New User + Actions/Search -->
<div
  class="mb-4 flex flex-col gap-2 sm:flex-row sm:flex-wrap sm:items-center sm:justify-between"
>
  <!-- Add User Button -->
  <button
    (click)="triggerPopup()"
    class="w-full rounded bg-blue-600 px-4 py-2 text-white hover:bg-blue-700 sm:w-auto"
  >
    Add New User
  </button>

  <!-- Actions & Search -->
  <div class="mt-2 flex flex-col gap-2 sm:mt-0 sm:flex-1 sm:flex-row sm:gap-3">
    <button
      (click)="selectAllUsers()"
      class="w-full rounded border bg-gray-200 px-3 py-1 sm:w-auto"
    >
      Select All
    </button>

    <button
      (click)="openBulkDeletionPopup()"
      [disabled]="selectedUsers.size === 0"
      class="w-full rounded bg-red-600 px-4 py-2 text-white disabled:opacity-50 sm:w-auto"
    >
      Delete Selected
    </button>

    <button
      (click)="blockInBulk(true)"
      [disabled]="selectedUsers.size === 0"
      class="w-full rounded bg-yellow-500 px-4 py-2 text-white disabled:opacity-50 sm:w-auto"
    >
      Block Selected
    </button>

    <button
      (click)="blockInBulk(false)"
      [disabled]="selectedUsers.size === 0"
      class="w-full rounded bg-green-600 px-4 py-2 text-white disabled:opacity-50 sm:w-auto"
    >
      Unblock Selected
    </button>

    <button
      (click)="addRandomUsers()"
      class="w-full rounded bg-blue-600 px-4 py-2 text-white sm:w-auto"
    >
      Add 1 Random User
    </button>

    <input
      type="text"
      placeholder="Search by name or email"
      class="w-full rounded border px-3 py-2 sm:flex-1"
      [value]="searchText()"
      (input)="searchText.set($any($event.target).value)"
    />
  </div>
</div>

<!-- Filters + Sorting -->
<div
  class="mb-4 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between"
>
  <!-- Filters -->
  <div class="flex flex-wrap gap-2">
    <button
      (click)="statusFilter.set('all')"
      [ngClass]="
        statusFilter() === 'all' ? 'bg-blue-500 text-white' : 'border bg-white'
      "
      class="rounded px-3 py-1"
    >
      All
    </button>
    <button
      (click)="statusFilter.set('vip')"
      [ngClass]="
        statusFilter() === 'vip' ? 'bg-blue-500 text-white' : 'border bg-white'
      "
      class="rounded px-3 py-1"
    >
      VIP
    </button>
    <button
      (click)="statusFilter.set('active')"
      [ngClass]="
        statusFilter() === 'active'
          ? 'bg-blue-500 text-white'
          : 'border bg-white'
      "
      class="rounded px-3 py-1"
    >
      Active
    </button>
    <button
      (click)="statusFilter.set('blocked')"
      [ngClass]="
        statusFilter() === 'blocked'
          ? 'bg-blue-500 text-white'
          : 'border bg-white'
      "
      class="rounded px-3 py-1"
    >
      Blocked
    </button>
    <button
      (click)="statusFilter.set('inactive')"
      [ngClass]="
        statusFilter() === 'inactive'
          ? 'bg-blue-500 text-white'
          : 'border bg-white'
      "
      class="rounded px-3 py-1"
    >
      Inactive
    </button>
  </div>

  <!-- Sorting -->
  <button
    (click)="toggleSortDirection()"
    class="mt-2 flex items-center gap-2 rounded border bg-purple-600 px-4 py-2 font-semibold text-white shadow hover:bg-purple-700 sm:mt-0"
  >
    Sorting: {{ sortAscending() ? 'Ascending' : 'Descending' }}
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-4 w-4"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
      stroke-width="2"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        [attr.d]="sortAscending() ? 'M5 15l7-7 7 7' : 'M19 9l-7 7-7-7'"
      />
    </svg>
  </button>
</div>

<!-- User Cards -->
<div class="flex flex-col gap-4">
  @for (user of paginatedUsers(); track trackByUserId($index, user)) {
    <div
      class="grid items-center gap-4 rounded-lg border p-4 shadow-sm transition hover:shadow-md md:grid-cols-[40px_50px_60px_1fr_90px_100px] lg:grid-cols-[50px_60px_60px_1fr_120px_120px_100px]"
      [ngClass]="{ 'bg-red-50': user.blocked, 'bg-white': !user.blocked }"
    >
      <!-- Checkbox -->
      <div class="flex justify-start md:justify-center">
        <input
          type="checkbox"
          [checked]="isUserSelected(user)"
          (change)="toggleUserSelection(user)"
          class="h-5 w-5"
        />
        <span class="ml-3 font-mono md:hidden">Select a user</span>
      </div>

      <!-- ID -->
      <div class="hidden text-center font-mono md:block">
        <span
          [ngClass]="{
            'bg-gray-200': user.blocked,
            'bg-gray-100': !user.blocked,
          }"
          class="rounded-2xl bg-gray-100 px-3 py-1 text-gray-600 shadow-sm"
          >#{{ user.userId }}</span
        >
      </div>

      <!-- Avatar -->
      <div class="flex items-center justify-start md:justify-center">
        <div
          class="mt-2 h-20 w-20 overflow-hidden rounded-full border-3 md:mt-0 md:h-12 md:w-12"
          [ngClass]="{
            'border-green-500': user.active,
            'border-gray-500': !user.active,
          }"
        >
          <img
            src="{{ user.picture }}"
            alt="avatar"
            class="h-full w-full object-cover"
          />
        </div>
      </div>

      <!-- Username + Email -->

      <div class="flex flex-col justify-center truncate">
        <span
          class="flex items-center justify-start gap-3 truncate font-semibold"
          >{{ user.username }}
          <span
            [ngClass]="{
              'bg-gray-100': !user.blocked,
              'bg-gray-200': user.blocked,
            }"
            class="rounded-2xl px-2 py-0.5 font-mono text-xs text-gray-600 md:hidden"
          >
            #{{ user.userId }}
          </span>
          @if (user.blocked) {
            <app-lock-icon></app-lock-icon>
          }
        </span>

        <span class="truncate text-sm break-words text-gray-500">{{
          user.email
        }}</span>
      </div>

      <!-- Mobile Status -->
      <div class="flex flex-wrap gap-2 md:gap-4 lg:hidden">
        <span
          [ngClass]="{
            'bg-green-100 px-4.5 text-green-700': user.active,
            'bg-gray-200 px-3 text-gray-700': !user.active,
          }"
          class="rounded-full py-1 text-xs shadow-sm md:text-sm md:font-semibold"
        >
          {{ user.active ? '  Active' : 'Inactive' }}
        </span>
        <span
          [ngClass]="{
            'bg-yellow-100 px-7 text-yellow-700': user.vip,
            'bg-purple-100 px-3 text-purple-700': !user.vip,
          }"
          class="rounded-full py-1 text-xs shadow-sm md:text-sm md:font-semibold"
          >{{ user.vip ? 'VIP' : 'Non-VIP' }}</span
        >
      </div>
      <!--Desktop status-->
      <div class="hidden text-center lg:block">
        <span
          [ngClass]="{
            'bg-green-100 px-4.5 text-green-700': user.active,
            'bg-gray-200 px-3 text-gray-700': !user.active,
          }"
          class="rounded-full py-1 shadow-sm"
        >
          {{ user.active ? '  Active' : 'Inactive' }}
        </span>
      </div>
      <div class="hidden text-center lg:block">
        <span
          [ngClass]="{
            'bg-yellow-100 px-7 text-yellow-700': user.vip,
            'bg-purple-100 px-3 text-purple-700': !user.vip,
          }"
          class="rounded-full py-1 shadow-sm"
          >{{ user.vip ? 'VIP' : 'Non-VIP' }}</span
        >
      </div>

      <!-- Actions -->
      <div class="flex items-end gap-2 md:flex-col">
        <button
          class="w-full rounded border bg-gray-200 px-2 py-1 text-center md:w-[80px]"
          (click)="toggleBlocked(user)"
        >
          {{ user.blocked ? 'Unblock' : 'Block' }}
        </button>
        <button
          class="w-full rounded border bg-red-600 px-2 py-1 text-white md:w-[80px]"
          (click)="deleteUserPopUp(user)"
        >
          Delete
        </button>
      </div>
    </div>
  }
</div>

<!-- Pagination -->
@if (visibleUsers().length > 0) {
  <div class="mt-4 flex flex-wrap items-center justify-center gap-2">
    <button
      (click)="prevPage()"
      [disabled]="currentPage() === 1"
      class="min-w-[50px] rounded border bg-gray-200 px-3 py-1"
    >
      Prev
    </button>

    @for (
      page of [].constructor(totalPages());
      track pageIndex;
      let pageIndex = $index
    ) {
      <button
        (click)="goToPage(pageIndex + 1)"
        [class.bg-blue-500]="currentPage() === pageIndex + 1"
        class="min-w-[40px] rounded border px-3 py-1"
      >
        {{ pageIndex + 1 }}
      </button>
    }

    <button
      (click)="nextPage()"
      [disabled]="currentPage() === totalPages()"
      class="min-w-[50px] rounded border bg-gray-200 px-3 py-1"
    >
      Next
    </button>
  </div>
}
